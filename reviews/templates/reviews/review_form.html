{% extends "base.html" %}
{% load verbatim %}
{% block extra_head %}
    {{ form.media.css }}
{% endblock %}


{% block content %}

<h1>Reviewing <a id="thing-link" href="{{ thing.get_absolute_url }}" data-uri="{{thing.uri}}">{{thing}}</a></h1>
<form method="post" action="">
{% csrf_token %}
{{ form.as_p }}

<div id="mentioned-lists">
	<ul id="mentioned-list"></ul>
	<ul id="mentionable-list"></ul>
</div>

<input type="submit" value="Submit" />
</form>
{% endblock content%}

{% block extra_scripts %}
 {{ form.media.js }}
<script src="{{ STATIC_URL }}3rdparty/sparql/sparql.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/handlebars/handlebars-1.0.0.beta.6.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/underscore/underscore-min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/backbone/backbone-min.js" type="text/javascript"></script>

{% verbatim %}
<script id="sparql-related-things" type="text/x-handlebars-template">
	SELECT DISTINCT ?thing ?name {
		{ <{{{uri}}}> ?p ?thing }
			UNION
		{ ?thing ?p <{{{uri}}}> }
		{ ?thing foaf:name ?name }
		UNION { ?thing rdfs:label ?name }
		UNION { ?thing dct:title ?name  }
	}
</script>


<script id="mentionable-tmpl" type="text/x-handlebars-template">
	<div class="mentionable" {{#if mentioned}} data-mentioned="true" {{/if}}>
		<input class="toggle" type="checkbox" {{#if mentioned}} checked="checked" {{/if}} />
		<label>{{label}}</label>
	</div>
</script>

<script type="text/javascript">
	
	$(function(){
		
		//Mentionable model
		
		var Mentionable = Backbone.Model.extend({
			defaults: function() {
				return {
					label: "no label",
					uri: "no uri",
					mentioned: false,
				}
			},
			
			toggle: function(){
				this.save({mentioned: !this.get("mentioned")})
			},
		})
			
		var MentionableList = Backbone.Collection.extend({
			model: Mentionable,
			
			mentioned: function() {
				return this.filter(function(mentionable){
					return mentionable.get('mentioned')
				})
			},
			
			unmentioned: function() {
				return this.without.apply(this, this.mentioned())
			}
		})
		
		var MentionableView = Backbone.View.extend({
			tagName: "li",
			template: Handlebars.compile($("#mentionable-tmpl").html()),
			
			events: {
				"click .toggle" : "toggleMentioned",
			},
			
			initialize: function(){
				this.model.bind('change', this.render, this)
			},
			
			render: function(){
				this.$el.html(this.template(this.model.toJSON()))
				return this
			},
			
			toggleMentioned: function(){
				this.model.toggle()
			}
		})
		
		var MentionListView = Backbone.View.extend({
			
			initialize: function(collection, list) {
				collection.bind('add', this.addOne, this);
				collection.bind('reset', this.addAll, this);
				collection.bind('all', this.render, this);
				this.list = list
			},
			
			addOne: function(mentionable) {
				var view = new MentionableView({model: mentionable});
				this.list.append(view.render().el);
			},
			
			addAll: function() {
				collection.each(this.addOne);
			},
			
		})
		
		var mentionables = new MentionableList;
		var mentioned = new MentionableList;
		
		
		var mentionableView = new MentionListView(mentionables, $("#mentionable-list"))
		var mentionedView = new MentionListView(mentioned, $("#mentioned-list"))
		
		
		var sparqlRelatedThings = Handlebars.compile($("#sparql-related-things").html())
		var relatedThings = Handlebars.compile($("#related-things").html())
		
		var sparqler = new SPARQL.Service("http://sparql.data.southampton.ac.uk/")
		
		sparqler.setPrefix("foaf", "http://xmlns.com/foaf/0.1/")
		sparqler.setPrefix("dct", "http://purl.org/dc/terms/")
		sparqler.setPrefix("rdfs", "http://www.w3.org/2000/01/rdf-schema#")
		
		sparqler.setOutput("json")
		sparqler.setMethod("POST")
		
			
		var query = sparqler.createQuery()
			
			
		query.query(
			sparqlRelatedThings({uri:$("#thing-link").attr("data-uri")}),
			{
				failure: function(){
					console.log("fail")
				},
				success: function(json) {

					for(var i=0; i<json.results.bindings.length; i++){
						var item = json.results.bindings[i]
						if (item.thing.type == "uri" && 'name' in item){
							mentionables.push(new Mentionable({ uri:item.thing.value, label:item.name.value}))
						}
					}
				}
			}
		)
	})
</script>
{% endverbatim %}
{% endblock %}
