{% extends "base.html" %}
{% load verbatim %}
{% block extra_head %}
    {{ form.media.css }}
{% endblock %}


{% block content %}

<h1>Reviewing <a id="thing-link" href="{{ thing.get_absolute_url }}" data-uri="{{thing.uri}}">{{thing}}</a></h1>
<form method="post" action="">
{% csrf_token %}
{{ form.as_p }}

<div id="mentioned-lists" hidden="hidden">

<ul id="mentioned" class="mentionables">
</ul>

<ul id="not-mentioned" class="mentionables">
</ul>

</div>

<input type="submit" value="Submit" />
</form>
{% endblock content%}

{% block extra_scripts %}
 {{ form.media.js }}
<script src="{{ STATIC_URL }}3rdparty/sparql/sparql.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/handlebars/handlebars-1.0.0.beta.6.js" type="text/javascript"></script>
{% verbatim %}
<script id="sparql-related-things" type="text/x-handlebars-template">
	SELECT DISTINCT ?thing ?name {
		{ <{{{uri}}}> ?p ?thing }
			UNION
		{ ?thing ?p <{{{uri}}}> }
		{ ?thing foaf:name ?name }
		UNION { ?thing rdfs:label ?name }
		UNION { ?thing dct:title ?name  }
	}
</script>

<script id="related-things" type="text/x-handlebars-template">
	{{#things}}
		<li data-uri="{{uri}}">{{name}}</li>
	{{/things}}
</script>

<script type="text/javascript">
	
	$(function(){
		var sparqlRelatedThings = Handlebars.compile($("#sparql-related-things").html())
		var relatedThings = Handlebars.compile($("#related-things").html())
		
		var sparqler = new SPARQL.Service("http://sparql.data.southampton.ac.uk/")
		
		sparqler.setPrefix("foaf", "http://xmlns.com/foaf/0.1/")
		sparqler.setPrefix("dct", "http://purl.org/dc/terms/")
		sparqler.setPrefix("rdfs", "http://www.w3.org/2000/01/rdf-schema#")
		
		sparqler.setOutput("json")
		sparqler.setMethod("POST")
		
			
		var query = sparqler.createQuery()
			
			
		//http://notes.3kbo.com/sparql-geolocation
		query.query(
			sparqlRelatedThings({uri:$("#thing-link").attr("data-uri")}),
			{
				failure: function(){
					console.log("fail")
				},
				success: function(json) {
					var context = {
						things : [
						]
					}

					for(var i=0; i<json.results.bindings.length; i++){
						var item = json.results.bindings[i]
						if (item.thing.type == "uri" && 'name' in item){
							context.things.push({ uri:item.thing.value, name:item.name.value})
						}
					}
					
					$("#not-mentioned").html(relatedThings(context))
					$("#mentioned-lists").removeAttr("hidden")
				}
			}
		)
		})
</script>
{% endverbatim %}
{% endblock %}
