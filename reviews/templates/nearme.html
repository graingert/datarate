{% extends "base.html" %}

{% block content %}

<form id="nearme-settings">
	<p><input name="latitude" min="-90" max="90" value="50.942921"/></p>
	<p><input name="longitude" min="-180" max="180" value="-1.401112"/></p>
	<p><input name="radius" value="0.1"/></p>
	<input type="submit" disabled="disabled" />
</form>
<div class="row">
	<div id="things-map" class="span8" style="height:250px"></div>
	<ul id="things-nearme" class="span4"></ul>
</div>
{% endblock content %}

{% block footer %}
	<p>This page uses <a href="http://www.movable-type.co.uk/scripts/latlong-db.html">code</a> from Chris Veness</p>
{% endblock %}

{% block extra_scripts %}
<script src="{{ STATIC_URL }}3rdparty/sparql/sparql.js" type="text/javascript"></script>
<script type="text/javascript">
	
	function rad2deg (angle) {
		// Converts the radian number to the equivalent number in degrees  
		// 
	    // version: 1109.2015
	    // discuss at: http://phpjs.org/functions/rad2deg    // +   original by: Enrique Gonzalez
	    // +      improved by: Brett Zamir (http://brett-zamir.me)
	    // *     example 1: rad2deg(3.141592653589793);
	    // *     returns 1: 180
	    return angle * 57.29577951308232; // angle / Math.PI * 180}
	}
	
	function deg2rad (angle) {
	    // Converts the number in degrees to the radian equivalent  
	    // 
	    // version: 1109.2015
	    // discuss at: http://phpjs.org/functions/deg2rad    // +   original by: Enrique Gonzalez
	    // +     improved by: Thomas Grainger (http://graingert.co.uk)
	    // *     example 1: deg2rad(45);
	    // *     returns 1: 0.7853981633974483
	    return angle * 0.017453292519943295; // (angle / 180) * Math.PI;
	}
	
	$(function(){
		
		var map = new OpenLayers.Map("things-map")
		var mapnik = new OpenLayers.Layer.OSM();
		map.addLayer(mapnik);
		map.zoomToMaxExtent();
		
		var sparqler = new SPARQL.Service("http://sparql.data.southampton.ac.uk/");
		
		sparqler.setPrefix("rdf", "http://www.w3.org/1999/02/22-rdf-syntax-ns#")
		sparqler.setPrefix("geo", "http://www.w3.org/2003/01/geo/wgs84_pos#")
		sparqler.setPrefix("rdfs", "http://www.w3.org/2000/01/rdf-schema#")
		
		sparqler.setOutput("json")
		sparqler.setMethod("POST")
		
		
		$("#nearme-settings").submit(function(e){
			var things = $("#things-nearme")
			things.empty()
			
			var lat = parseFloat($(this).find("input[name=latitude]").val())
			var lng = parseFloat($(this).find("input[name=longitude]").val())
			var radius = parseFloat($(this).find("input[name=radius]").val())
			var earth_r = 6371.0; //Earth's radius
			
			map.setCenter(new OpenLayers.LonLat(lng, lat), 16)
			
			// first-cut bounding box (in degrees)
			var maxLat = lat + rad2deg(radius/earth_r)
			var minLat = lat - rad2deg(radius/earth_r)
			// compensate for degrees longitude getting smaller with increasing latitude
			var maxLng = lng + rad2deg(radius/earth_r/Math.cos(deg2rad(lat)))
			var minLng = lng - rad2deg(radius/earth_r/Math.cos(deg2rad(lat)))
			
			var query = sparqler.createQuery()
			
			
			//http://notes.3kbo.com/sparql-geolocation
			query.query(
				'SELECT * WHERE {\n\
					?s geo:lat ?lat .\n\
					?s geo:long ?long .\n\
					?s rdfs:label ?label .\n\
					FILTER ( ?long > ' + minLng + ' && ?long < ' + maxLng + '&& ?lat > ' + minLat +' && ?lat < '+ maxLat +')\n\
				} LIMIT 100',
				{
					failure: function(){
						console.log("fail")
					},
					success: function(json) {

						for(var i=0; i<json.results.bindings.length; i++){
							var item = json.results.bindings[i]
							things.append('<li><a href="' + item.s.value + '">'+item.label.value+'</a></li>')
						}
					}
				}
			)
		return false
		})
		$("#nearme-settings input[type=submit]").removeAttr("disabled")
	})
</script>
<script src="http://www.openlayers.org/api/OpenLayers.js"></script>

{% endblock %}
