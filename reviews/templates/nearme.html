{% extends "base.html" %}
{% load verbatim %}
{% block content %}

<h1>Geolocate Things near me</h1>
<div id="geo">
<button id="geolocate" class="btn btn-primary btn-large">Geolocate</button>
</div>

<div id="geofallback" hidden="hidden">
	<div class="alert alert-error">
		Sorry, had to fall back to manual location entry because <span class="reason">something went wrong</span>
    </div>
	<form id="nearme-settings">
		<p><input name="latitude" min="-90" max="90" value="50.942921"/></p>
		<p><input name="longitude" min="-180" max="180" value="-1.401112"/></p>
		<p><input name="radius" value="0.1"/></p>
		<input type="submit" disabled="disabled" />
	</form>
</div>
<div class="row" hidden="hidden" id="things-nearme">

</div>
{% endblock content %}

{% block footer %}
	<p>This page uses <a href="http://www.movable-type.co.uk/scripts/latlong-db.html">code</a> from Chris Veness</p>
{% endblock %}

{% block extra_scripts %}
<script src="{{ STATIC_URL }}3rdparty/sparql/sparql.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/handlebars/handlebars-1.0.0.beta.6.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}3rdparty/URI/URI.js" type="text/javascript"></script>
{%verbatim%}

<!--http://notes.3kbo.com/sparql-geolocation-->
<script id="sparql-things-nearme" type="text/x-handlebars-template">
	SELECT * WHERE {
		?s geo:lat ?lat .
		?s geo:long ?long .
		?s rdfs:label ?label .
		FILTER ( ?long > {{minLng}} && ?long < {{maxLng}} && ?lat > {{minLat}} && ?lat < {{maxLat}})
	} LIMIT 100
</script>

<script id="things-nearme-tmpl" type="text/x-handlebars-template">
	<div  class="span4">
		<h2>Geolocated Things</h2>
		<p>Your location: {{lng}}, {{lat}}<p>
		{{#if things.length}}
			<ol class="thing-stream stream well">
				{{#things}}
				<li>
				<article class="thing">
					<header>
						<a href="{{uri}}">
							<h2 class="name">{{name}}</h2>
						</a>
					</header>
					<div class="btn-group">
						<a class="btn" href="{{api_url}}">View Reviews</a>
					</div>
				</article>
				</li>
				{{/things}}
			</ol>
		{{else}}
			<div class="alert alert-error">
				Sorry, no Things nearby
			</div>
		{{/if}}
	</div>
</script>


<script type="text/javascript">
	
	function rad2deg (angle) {
		// Converts the radian number to the equivalent number in degrees  
		// 
	    // version: 1109.2015
	    // discuss at: http://phpjs.org/functions/rad2deg    // +   original by: Enrique Gonzalez
	    // +      improved by: Brett Zamir (http://brett-zamir.me)
	    // *     example 1: rad2deg(3.141592653589793);
	    // *     returns 1: 180
	    return angle * 57.29577951308232; // angle / Math.PI * 180}
	}
	
	function deg2rad (angle) {
	    // Converts the number in degrees to the radian equivalent  
	    // 
	    // version: 1109.2015
	    // discuss at: http://phpjs.org/functions/deg2rad    // +   original by: Enrique Gonzalez
	    // +     improved by: Thomas Grainger (http://graingert.co.uk)
	    // *     example 1: deg2rad(45);
	    // *     returns 1: 0.7853981633974483
	    return angle * 0.017453292519943295; // (angle / 180) * Math.PI;
	}
	
	$(function(){
		
		var sparqlThingsNearme = Handlebars.compile($("#sparql-things-nearme").html())
		var thingsNearme = Handlebars.compile($("#things-nearme-tmpl").html())
		
		var sparqler = new SPARQL.Service("http://sparql.data.southampton.ac.uk/");
		
		sparqler.setPrefix("rdf", "http://www.w3.org/1999/02/22-rdf-syntax-ns#")
		sparqler.setPrefix("geo", "http://www.w3.org/2003/01/geo/wgs84_pos#")
		sparqler.setPrefix("rdfs", "http://www.w3.org/2000/01/rdf-schema#")
		
		sparqler.setOutput("json")
		sparqler.setMethod("POST")
		
		
		
		if (navigator.geolocation) {
			console.log("geolocation supported")
			$("#geolocate").click(geolocate)
		} else {
			fallback("Geolocation is unsuported on this platform")
		}
		
		function fallback(reason){
			$("#geo").attr("hidden", "hidden")
			
			$("#nearme-settings").submit(function(e){
				var lat = parseFloat($(this).find("input[name=latitude]").val())
				var lng = parseFloat($(this).find("input[name=longitude]").val())
				var radius = parseFloat($(this).find("input[name=radius]").val())
				
				nearme(lat, lng, radius)
				return false
			})
			$("#nearme-settings input[type=submit]").removeAttr("disabled")
			
			
			$("#geofallback reason").html(reason)
			$("#geofallback").removeAttr("hidden")
		}
		
		function geolocate(e){
			navigator.geolocation.getCurrentPosition(
			function(position){
				nearme(position.coords.latitude, position.coords.longitude, 0.005)
			}, function (error){
				console.log(error)
				switch(error.code) 
				{
					case error.TIMEOUT:
						fallback('Geolocation Timed out');
						break;
					case error.POSITION_UNAVAILABLE:
						fallback ('your Position was unavailable');
						break;
					case error.PERMISSION_DENIED:
						fallback ('permission to the Geolocation API was denied');
						break;
					case error.UNKNOWN_ERROR:
					default:
						fallback ('something went wrong');
						break;
				}
			},
			
			{ enableHighAccuracy: true }
			)
		}
		
		function nearme(lat, lng, radius){
			var earth_r = 6371.0; //Earth's radius
			// first-cut bounding box (in degrees)
			var maxLat = lat + rad2deg(radius/earth_r)
			var minLat = lat - rad2deg(radius/earth_r)
			// compensate for degrees longitude getting smaller with increasing latitude
			var maxLng = lng + rad2deg(radius/earth_r/Math.cos(deg2rad(lat)))
			var minLng = lng - rad2deg(radius/earth_r/Math.cos(deg2rad(lat)))
			
			var query = sparqler.createQuery()
			
			query.query(
				sparqlThingsNearme({minLng:minLng, maxLng:maxLng, minLat:minLat, maxLat:maxLat}),
				{
					failure: function(){
						console.log("fail")
					},
					success: function(json) {
						context = {
								lng: lng,
								lat: lat,
								things: []
						}
						for(var i=0; i<json.results.bindings.length; i++){
							var item = json.results.bindings[i]
							context.things.push({uri : item.s.value,  name : item.label.value, api_url: URI("/thing.html").search({uri : item.s.value}) })
						}
						$("#things-nearme").html(thingsNearme(context))
						$("#things-nearme").removeAttr("hidden")
					}
				}
			)
		}
	})
</script>
{%endverbatim%}
{% endblock %}
